---
layout: post
title: Handler 工作原理
date: 2019-08-01 08:56:49
tags: Android_Handler
category: Android 9.0 源码分析
---
### 消息三件套
1. Looper

本质上就是一个无限循环，像水泵一样抽取MessageQueue里的消息，并执行相对应的callback。

2. MessageQueue

消息队列，一个存取消息的容器，在Android这儿是一个单向链表，当有消息加入时，会根据消息需要执行的时刻将消息插入到链表合适的位置，所以总是执行链表第一个消息。当没有消息或者最近一段时间没有消息时候会阻塞住。也能移除队列中的消息。

3. Handler

像把手一样，对开发者提供一个易用的类，方便开发者增加删除消息。

### 消息三件套的关系
1. 一个进程只有一个主消息循环，保存在静态变量中。
2. 每个线程都可以变成消息队列，如没有指明消息循环，Handler绑定的是主消息队列。
3. 消息的callback保存在message的target中，执行消息时候会执行这个callback。

### MessageQueue怎么维护消息队列的
1. 插入消息

会判断是否是延时消息，如果是会加入到链表头，并唤醒阻塞，立即执行，如果不是则会根据延时的时间，从链表头往后找，找到比后一个小前一个大的位置插入链表。

2. 获取消息

每次尝试阻塞，阻塞的时间依据消息队列第一个消息的延时时间，阻塞通过后会找到第一个非异步消息，进行执行。

3. 删除消息

根据不同的条件找到队列里的消息进行移除（链表操作）。

### MessageQueue怎么阻塞的
在MessageQueue建立的时候，会在C层建立一个epoll，正是利用linux epoll_wait的模式来实现消息阻塞。为什么要用epoll，因为主消息循环就一个，需要和Android其他消息（键盘，触摸事件）进行统一处理。